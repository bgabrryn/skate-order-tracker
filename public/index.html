<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Order Tracking - Boot & Blade</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
  </style>
</head>
<body class="bg-black min-h-screen text-white">
  <div id="app"></div>

  <script>
    const statusContent = {
      'placed': {
        title: 'Your Order Has Been Placed',
        description: `We've placed your order with the UK warehouse.
If the skates are available, they should be with us next week.
If they're not available in the UK, there may be a longer wait – we'll be in touch if this is the case.`
      },
      'not-in-uk': {
        title: 'On The Way to the UK',
        description: `Your skates weren't available in the UK, but we've requested them to be shipped to us. The timeline is usually 2-3 weeks for this – we'll be in touch if it's any different.`
      },
      'on-the-way': {
        title: 'On The Way to the UK',
        description: `Your skates weren't available in the UK, but we've requested them to be shipped to us. The timeline is usually 2-3 weeks for this – we'll be in touch if it's any different.`
      },
      'ready-to-try': {
        title: 'Your Skates Have Arrived!',
        description: `Your skates are in-store and ready to try on. Check your email for a confirmation, and the appointment booking link.

See you soon!`
      },
      'collected': {
        title: 'Enjoy Your Skates!',
        description: `Thanks for shopping with us. Remember, if you have any issues with the fit – we'll fix it. All skates are covered by our Love Skate Guarantee.`
      }
    };

    function mapStatusToKey(status) {
      // If status is already a key, return it as-is
      const validKeys = ['placed', 'not-in-uk', 'on-the-way', 'ready-to-try', 'collected'];
      if (validKeys.includes(status)) {
        return status;
      }
      
      // Otherwise, map from raw status string to key
      const mapping = {
        'Placed with Supplier': 'placed',
        'Not in UK': 'not-in-uk',
        'On the way': 'on-the-way',
        'Ready to try on': 'ready-to-try',
        'Collected': 'collected'
      };
      return mapping[status] || 'placed';
    }

    async function loadOrderData() {
      const app = document.getElementById('app');
      
      // Show loading
      app.innerHTML = `
        <div class="min-h-screen flex items-center justify-center">
          <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-400 mx-auto mb-4"></div>
            <p class="text-gray-400">Loading your order...</p>
          </div>
        </div>
      `;

      try {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        if (!token) {
          throw new Error('No tracking token provided');
        }

        // Add cache-busting timestamp to prevent browser caching
        const timestamp = new Date().getTime();
        const response = await fetch(`/api/track?token=${token}&_t=${timestamp}`, {
          cache: 'no-store',
          headers: {
            'Cache-Control': 'no-cache'
          }
        });
        const data = await response.json();
        
        // Debug logging
        console.log('[Frontend] API Response:', data);
        console.log('[Frontend] Items:', data.items);
        if (data.items && data.items.length > 0) {
          console.log('[Frontend] Item statuses:', data.items.map(item => item.status));
        }
        
        if (data.error) {
          throw new Error(data.error);
        }

        // Determine overall status (use the latest/most advanced status)
        const statusPriority = ['placed', 'not-in-uk', 'on-the-way', 'ready-to-try', 'collected'];
        let currentStatus = 'placed';
        
        if (data.items && data.items.length > 0) {
          // Map raw status strings to their keys
          const statuses = data.items.map(item => mapStatusToKey(item.status));
          console.log('[Frontend] All statuses found:', statuses);
          console.log('[Frontend] Full items data:', JSON.stringify(data.items, null, 2));
          
          // Find the most advanced (latest) status in the journey
          // Reverse iterate through priority to find the highest status
          for (let i = statusPriority.length - 1; i >= 0; i--) {
            const status = statusPriority[i];
            if (statuses.includes(status)) {
              currentStatus = status;
              break;
            }
          }
          
          console.log('[Frontend] Selected currentStatus:', currentStatus);
          console.log('[Frontend] Status content available:', statusContent[currentStatus]);
        } else {
          console.warn('[Frontend] No items found in data:', data);
        }

        const content = statusContent[currentStatus];
        if (!content) {
          console.error('[Frontend] No content found for status:', currentStatus);
          console.error('[Frontend] Available statuses in statusContent:', Object.keys(statusContent));
        }
        const lastReviewed = data.items[0]?.lastReviewed || 'Today';

        app.innerHTML = `
          <div class="min-h-screen px-4 py-8 md:py-16 flex flex-col items-center justify-center fade-in">
            <div class="max-w-2xl w-full">
              <!-- Logo -->
              <div class="text-center mb-8">
                <img 
                  src="/logo.svg" 
                  alt="Boot & Blade" 
                  class="mx-auto mb-4 h-auto"
                  style="width: 96px;"
                  onerror="this.onerror=null; this.src='/logo.svg'; this.onerror=function(){this.style.display='none'; document.getElementById('logo-fallback').style.display='block';}"
                >
                <h1 id="logo-fallback" class="text-5xl md:text-6xl font-serif text-yellow-400 mb-4" style="display:none;">
                  Boot<br class="md:hidden">&<span class="md:inline">Blade</span>
                </h1>
                <h2 class="text-3xl md:text-3xl font-bold mb-2 pt-4 pb-4">Are my skates here yet?</h2>
              </div>

              <!-- Status Card -->
              <div class="bg-gray-100 text-gray-900 rounded-3xl p-8 md:p-10 shadow-2xl">
                <p class="text-sm text-gray-600 mb-6">Last Updated ${lastReviewed}</p>
                
                <h3 class="text-2xl md:text-3xl font-bold mb-4">${content.title}</h3>
                <p class="text-gray-700 whitespace-pre-line leading-relaxed mb-8">${content.description}</p>

                <!-- Your Order Section -->
                <div class="border-t border-gray-300 pt-6">
                  <h4 class="text-lg font-semibold mb-4 text-gray-800">Your Order</h4>
                  ${data.items.map(item => `
                    <div class="mb-4">
                      <p class="font-semibold text-gray-900">${item.model}</p>
                      ${item.size ? `<p class="text-gray-600">Size ${item.size}</p>` : ''}
                    </div>
                  `).join('')}
                </div>

                ${currentStatus === 'ready-to-try' ? `
                  <div class="mt-8">
                    <a 
                      href="https://calendly.com/thebootandblade/collect" 
                      target="_blank"
                      rel="noopener noreferrer"
                      class="block w-full text-center bg-black text-white py-4 rounded-2xl font-semibold hover:bg-gray-800 transition text-lg"
                    >
                      Book Your Fitting Appointment
                    </a>
                  </div>
                ` : ''}
              </div>

              <!-- Footer -->
              <div class="text-center mt-8 text-gray-400 text-sm">
                <p>Questions about your order?</p>
                <a href="mailto:bradley@thebootandblade.com" class="text-yellow-400 hover:text-yellow-300 transition">
                  Get in touch with us
                </a>
              </div>
            </div>
          </div>
        `;
        
      } catch (error) {
        app.innerHTML = `
          <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-gray-100 text-gray-900 rounded-3xl p-8 max-w-md text-center shadow-2xl">
              <p class="text-red-600 mb-4 font-semibold">${error.message}</p>
              <a href="mailto:support@bootandblade.com" class="text-yellow-600 hover:text-yellow-700 underline">
                Contact support
              </a>
            </div>
          </div>
        `;
      }
    }

    // Load order data when page loads
    loadOrderData();
  </script>
</body>
</html>